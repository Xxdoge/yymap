<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­æ•°æ®åœ°å›¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .map-container {
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            height: 100%;
            width: 100%;
            background: #f0f0f0;
            position: relative;
            overflow: auto;
        }
        
        
        .map-placeholder {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .map-placeholder h3 {
            margin-bottom: 20px;
            color: #1e5799;
        }
        
        .upload-btn {
            background: #1e5799;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px;
        }
        
        .upload-btn:hover {
            background: #16437e;
        }
        
        .info-panel {
            width: 350px;
            background: white;
            padding: 20px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .panel-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #1e5799;
            border-bottom: 2px solid #eaeaea;
            padding-bottom: 10px;
        }
        
        .instructions {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #1e5799;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            background: #1e5799;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #16437e;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .risk-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .risk-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .risk-item:hover {
            background: #f0f7ff;
        }
        
        .risk-title {
            font-weight: bold;
            color: #1e5799;
        }
        
        .risk-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .high-risk {
            background: #ffebee;
            color: #e53935;
        }
        
        .medium-risk {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .low-risk {
            background: #e8f5e9;
            color: #43a047;
        }
        
        
        
        .admin-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 999;
            display: none; /* é»˜è®¤éšè—ç®¡ç†å‘˜æŒ‰é’® */
        }
        
        .mode-switch {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .mode-switch:hover {
            background: #218838;
        }
        
        .mode-switch.admin {
            background: #dc3545;
        }
        
        .mode-switch.admin:hover {
            background: #c82333;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-mode .admin-only {
            display: block;
        }
        
        .viewer-mode .admin-only {
            display: none !important;
        }
        
        .risk-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            z-index: 100;
            transform: translate(-50%, -50%);
        }
        
        .risk-marker.high {
            background-color: #43a047;
            box-shadow: 0 0 10px rgba(67, 160, 71, 0.7);
        }
        
        .risk-marker.medium {
            background-color: #43a047;
            box-shadow: 0 0 10px rgba(67, 160, 71, 0.7);
        }
        
        .risk-marker.low {
            background-color: #43a047;
            box-shadow: 0 0 10px rgba(67, 160, 71, 0.7);
        }
        
        .risk-marker.selected {
            width: 28px;
            height: 28px;
            border: 4px solid #1e5799;
            box-shadow: 0 0 20px rgba(30, 87, 153, 1);
            z-index: 1000;
        }
        
        .risk-tooltip {
            position: fixed;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 320px;
            max-width: 400px;
            display: none;
            border: 2px solid #e0e0e0;
            overflow: hidden; /* é˜²æ­¢å†…å®¹è¶…å‡ºå¡ç‰‡ */
        }
        
        .risk-tooltip h4 {
            margin: 0 0 15px 0;
            color: #1e5799;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .tooltip-row {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        .tooltip-label {
            font-weight: bold;
            color: #555;
            min-width: 90px;
            font-size: 14px;
        }
        
        .tooltip-value {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            flex: 1;
        }
        
        .risk-tooltip .risk-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .tooltip-image {
            margin-top: 15px;
            /* åŸºç¡€å°ºå¯¸ï¼š150px x 120pxï¼Œä½†é™åˆ¶æœ€å¤§å°ºå¯¸ä»¥é€‚åº”å¡ç‰‡ */
            width: 150px;
            height: 120px;
            max-width: calc(100% - 40px); /* è€ƒè™‘å¡ç‰‡padding */
            max-height: 120px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        /* å¤šå›¾ç‰‡å®¹å™¨æ ·å¼è°ƒæ•´ - æ¨ªå‘æ»šåŠ¨ */
        #tooltip-images-container {
            display: flex;
            flex-wrap: nowrap; /* ä¸æ¢è¡Œï¼Œæ¨ªå‘æ’åˆ— */
            gap: 8px;
            margin-top: 0; /* è·ç¦»æ ‡ç­¾å¾ˆè¿‘ */
            overflow-x: auto; /* æ¨ªå‘æ»šåŠ¨ */
            overflow-y: hidden;
            padding-bottom: 8px; /* ä¸ºæ»šåŠ¨æ¡ç•™ç©ºé—´ */
            max-width: calc(100% - 40px); /* è€ƒè™‘å¡ç‰‡çš„padding */
            width: 100%; /* å æ»¡å¯ç”¨å®½åº¦ */
            /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }
        
        #tooltip-images-container::-webkit-scrollbar {
            height: 6px;
        }
        
        #tooltip-images-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #tooltip-images-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        #tooltip-images-container::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        
        /* å¤šå›¾ç‰‡æ—¶çš„æ ·å¼è°ƒæ•´ */
        #tooltip-images-container .tooltip-image {
            margin: 2px;
            flex-shrink: 0; /* é˜²æ­¢å›¾ç‰‡è¢«å‹ç¼© */
            max-width: 150px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œç¡®ä¿ä¸ä¼šè¶…å‡ºå®¹å™¨ */
            max-height: 120px;
        }
        
        .tooltip-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹æ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 20000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .image-modal-close:hover {
            color: #bbb;
        }
        
        #image-preview img {
            max-width: 100%;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .map-image {
            width: 100%;
            height: auto;
            display: block;
            user-select: none;
            -webkit-user-drag: none;
        }
        
        #markers-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .risk-marker {
            pointer-events: auto;
        }
        
        .map-container {
            cursor: grab;
        }
        
        .map-container.dragging {
            cursor: grabbing;
        }
        
        /* èƒŒæ™¯éŸ³ä¹æ§åˆ¶æ ·å¼ */
        .music-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            padding: 8px 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .music-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .music-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .music-volume {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        
        .music-volume::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* å¤šå›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .preview-image {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-image .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    
    <!-- å¼•å…¥ axios - å¤šä¸ªå¤‡ç”¨CDN -->
    <script>
        // é¦–å…ˆæ£€æŸ¥axiosæ˜¯å¦å·²ç»åŠ è½½
        if (typeof axios === 'undefined') {
            // åˆ›å»ºå¤šä¸ªå¤‡ç”¨CDNçš„åŠ è½½å‡½æ•°
            function loadAxiosFromCDN() {
                const cdnList = [
                    'https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js',
                    'https://unpkg.com/axios/dist/axios.min.js',
                    'https://cdn.skypack.dev/axios/dist/axios.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoadCDN() {
                    if (currentIndex >= cdnList.length) {
                        console.error('æ‰€æœ‰CDNéƒ½æ— æ³•åŠ è½½axiosï¼Œå°†ä½¿ç”¨fetchä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
                        // å¦‚æœæ‰€æœ‰CDNéƒ½å¤±è´¥ï¼Œæˆ‘ä»¬å°†åœ¨ä»£ç ä¸­ä½¿ç”¨fetchæ›¿ä»£
                        window.axios = {
                            request: async function(config) {
                                try {
                                    const response = await fetch(config.url, {
                                        method: config.method || 'GET',
                                        headers: config.headers || {},
                                        body: config.data ? JSON.stringify(config.data) : undefined
                                    });
                                    
                                    if (!response.ok) {
                                        const error = new Error(`HTTP ${response.status} ${response.statusText}`);
                                        error.response = {
                                            status: response.status,
                                            statusText: response.statusText
                                        };
                                        throw error;
                                    }
                                    
                                    let data;
                                    try {
                                        data = await response.json();
                                    } catch (e) {
                                        data = await response.text();
                                    }
                                    
                                    return { data: data };
                                } catch (error) {
                                    if (!error.response) {
                                        error.request = true;
                                    }
                                    throw error;
                                }
                            }
                        };
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    script.onload = function() {
                        console.log(`âœ… æˆåŠŸä»CDNåŠ è½½axios: ${cdnList[currentIndex]}`);
                    };
                    script.onerror = function() {
                        console.warn(`âŒ CDNåŠ è½½å¤±è´¥: ${cdnList[currentIndex]}`);
                        currentIndex++;
                        tryLoadCDN();
                    };
                    document.head.appendChild(script);
                }
                
                tryLoadCDN();
            }
            
            // ç«‹å³å°è¯•åŠ è½½
            loadAxiosFromCDN();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container viewer-mode" id="app-container">
        
        
        <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶ -->
        <div class="music-controls">
            <button class="music-toggle" id="music-toggle">ğŸµ</button>
            <input type="range" class="music-volume" id="music-volume" min="0" max="100" value="30">
            <audio id="background-music" loop></audio>
        </div>
        
        <div class="admin-controls">
            <button class="mode-switch" id="mode-switch">ç®¡ç†å‘˜æ¨¡å¼</button>
        </div>
        
        <div class="map-container">
            <div id="map">
                <img id="map-image" class="map-image" src="æ¨å›­ä¸­å­¦å¹³é¢å›¾plus.jpg" alt="æ ¡å›­åœ°å›¾">
                <div id="markers-container"></div>
                <div id="tooltip" class="risk-tooltip"></div>
            </div>
        </div>
        
        <div class="info-panel" id="info-panel">
            <div class="panel-content">
                <h2 class="panel-title">æ•°å­—ç”Ÿå­˜æŒ‡å—</h2>
                
                <div class="instructions admin-only">
                    <h3>ç®¡ç†å‘˜ä½¿ç”¨è¯´æ˜</h3>
                    <ul>
                        <li>ç‚¹å‡»å³ä¸Šè§’"ç®¡ç†å‘˜æ¨¡å¼"æŒ‰é’®è¿›å…¥ç¼–è¾‘ç•Œé¢</li>
                        <li>å¡«å†™æ•°æ®ç±»å‹ã€åœ°ç‚¹åç§°å’Œæ•°å­—ç”Ÿå­˜æŒ‡å—</li>
                        <li>ç‚¹å‡»åœ°å›¾ä½ç½®ç›´æ¥ç”Ÿæˆæ ‡è®°</li>
                        <li>ç‚¹å‡»å·²æœ‰æ ‡è®°å¯æŸ¥çœ‹å’Œç¼–è¾‘ä¿¡æ¯</li>
                        <li>ç‚¹å‡»"åˆ é™¤æ ‡è®°"åˆ é™¤é€‰ä¸­çš„æ ‡è®°</li>
                        <li>ç‚¹å‡»"ä¿å­˜æ‰€æœ‰æ ‡è®°"å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶</li>
                    </ul>
                </div>
                
                <div class="instructions viewer-mode">
                    <h3>æŸ¥çœ‹è¯´æ˜</h3>
                    <ul>
                        <li>ç‚¹å‡»æ ‡è®°ç‚¹æŸ¥çœ‹æ•°æ®ä¿¡æ¯</li>
                        <li>ç‚¹å‡»ä¿¡æ¯å¡ç‰‡ä¸­çš„å›¾ç‰‡å¯æ”¾å¤§æŸ¥çœ‹</li>
                        <li>ç‚¹å‡»å¡ç‰‡å¤–åŒºåŸŸå…³é—­ä¿¡æ¯å¡ç‰‡</li>
                    </ul>
                </div>
                
                <div class="admin-only">
                    <div class="form-group">
                        <label for="risk-title">åœ°ç‚¹åç§°</label>
                        <input type="text" id="risk-title" placeholder="ä¾‹å¦‚ï¼šæ•™å­¦æ¥¼Aåº§">
                    </div>
                    
                    <div class="form-group">
                        <label for="risk-type">æµ‹é‡æ–¹æ³•ï¼ˆé€‰å¡«ï¼‰</label>
                        <input type="text" id="risk-type" placeholder="ä¾‹å¦‚ï¼šæ¿€å…‰æµ‹è·ä»ªã€å·å°ºæµ‹é‡ã€GPSå®šä½">
                    </div>
                    
                    <div class="form-group">
                        <label for="risk-data">æµ‹é‡å€¼ï¼ˆé€‰å¡«ï¼‰</label>
                        <textarea id="risk-data" placeholder="ä¾‹å¦‚ï¼š&#10;æ¥¼é«˜ï¼š21.8ç±³&#10;å®½åº¦ï¼š15ç±³&#10;å±‚é«˜ï¼š3.5ç±³" style="height: 80px;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="risk-description">æ•°å­—ç”Ÿå­˜æŒ‡å—</label>
                        <textarea id="risk-description" placeholder="è¯¦ç»†æè¿°æ•°å­—ç”Ÿå­˜æŒ‡å—..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="risk-image">å®æ™¯å›¾ç‰‡ï¼ˆé€‰å¡«ï¼Œæœ€å¤š10å¼ ï¼‰</label>
                        <input type="file" id="risk-image" accept="image/*" multiple style="padding: 5px;">
                        <div id="image-preview" class="image-preview-container" style="margin-top: 10px; max-width: 100%;"></div>
                    </div>
                    
                    <div class="btn-group">
                        <button id="update-marker-btn" class="btn" style="display: none;">æ›´æ–°æ ‡è®°</button>
                        <button id="clear-btn" class="btn btn-danger">åˆ é™¤æ ‡è®°</button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 10px;">
                        <button id="save-all-btn" class="btn" style="background: #28a745;">ä¿å­˜æ‰€æœ‰æ ‡è®°</button>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #f0f7ff; border-radius: 5px; font-size: 12px;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚ç‚¹å‡»"ä¿å­˜æ‰€æœ‰æ ‡è®°"å¯ä»¥æ‰‹åŠ¨ä¿å­˜æ‰€æœ‰æ ‡è®°åˆ°æœåŠ¡å™¨ï¼Œå¤šç”¨æˆ·å…±äº«æ•°æ®ã€‚
                    </div>
                </div>
                
                <div class="risk-list">
                    <h3>å·²æ ‡è®°çš„æ•°æ®ç‚¹</h3>
                    <div id="risk-items">
                        <!-- æ•°æ®ç‚¹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="image-modal" class="image-modal">
        <span class="image-modal-close" id="modal-close">&times;</span>
        <img id="modal-image" class="image-modal-content" alt="æ”¾å¤§å›¾ç‰‡">
    </div>

    <script>
        // å…¨å±€å˜é‡
        let riskPoints = [];
        let selectedMarker = null;
        let isAdminMode = false;
        let mapImage = null;
        let mapContainer = null;
        let markersContainer = null;
        let tooltip = null;
        let pendingMarkerPosition = null; // å¾…æ·»åŠ æ ‡è®°çš„ä½ç½®
        let selectedImages = []; // å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ•°æ®
        
        // åœ°å›¾äº¤äº’ç›¸å…³å˜é‡
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let scrollLeft = 0;
        let scrollTop = 0;
        
        // API é…ç½®
        const API_CONFIG = {
            // æ™ºèƒ½APIåœ°å€é€‰æ‹©
            baseUrl: (function() {
                const isHttps = window.location.protocol === 'https:';
                const isNetlify = window.location.hostname.includes('netlify');
                const serverHost = '124.223.222.214:3000';
                
                // å¦‚æœæ˜¯Netlifyç¯å¢ƒï¼Œå°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡ä»£ç†ï¼‰
                if (isNetlify) {
                    // åœ¨Netlifyä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä»£ç†æ¥è½¬å‘APIè¯·æ±‚
                    return '/api';
                } else if (isHttps) {
                    // å…¶ä»–HTTPSç¯å¢ƒï¼Œå°è¯•HTTPS
                    return `https://${serverHost}/api`;
                } else {
                    // HTTPç¯å¢ƒä½¿ç”¨HTTP
                    return `http://${serverHost}/api`;
                }
            })(),
            timeout: 10000, // 10ç§’è¶…æ—¶
            // æ·»åŠ å¤‡ç”¨URLé…ç½®ï¼Œç”¨äºå›é€€
            fallbackUrls: [
                '/api',  // Netlifyä»£ç†è·¯å¾„
                'http://124.223.222.214:3000/api',  // åŸå§‹HTTPåœ°å€
                'https://124.223.222.214:3000/api'  // HTTPSåœ°å€ï¼ˆå¦‚æœæœåŠ¡å™¨æ”¯æŒï¼‰
            ]
        };
        
        // æ•°æ®ç±»å‹é…ç½®ï¼ˆä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼Œä½†ä¸å†ä½¿ç”¨ï¼‰
        const riskTypes = {
            high: { name: 'é«˜é£é™©', color: '#e53935', className: 'high-risk' },
            medium: { name: 'ä¸­é£é™©', color: '#ff9800', className: 'medium-risk' },
            low: { name: 'ä½é£é™©', color: '#43a047', className: 'low-risk' }
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            mapContainer = document.getElementById('map');
            markersContainer = document.getElementById('markers-container');
            tooltip = document.getElementById('tooltip');
            mapImage = document.getElementById('map-image');
            
            try {
                await initializeApp();
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
        
        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            setupEventListeners();
            updateModeDisplay();
            enableAdminAccess(); // å¯ç”¨ç®¡ç†å‘˜è®¿é—®åŠŸèƒ½
            
            // ç¡®ä¿axiosåŠ è½½å®Œæˆåå†åŠ è½½æ•°æ®
            try {
                await ensureAxiosAvailable();
                console.log('âœ… axioså·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹åŠ è½½æ•°æ®');
            } catch (error) {
                console.warn('âš ï¸ axiosåŠ è½½å¯èƒ½æœ‰é—®é¢˜ï¼Œä½†ä»ä¼šå°è¯•åŠ è½½æ•°æ®:', error);
            }
            
            // åŠ è½½æ•°æ®ï¼ˆæ— è®ºaxiosæ˜¯å¦å¯ç”¨éƒ½ä¼šå°è¯•ï¼‰
            loadData();
        }
        
        // å¯ç”¨ç®¡ç†å‘˜è®¿é—®ï¼ˆé€šè¿‡æŒ‰é”®æˆ–æ§åˆ¶å°å‘½ä»¤ï¼‰
        function enableAdminAccess() {
            // æ–¹æ³•1: è¿ç»­æŒ‰3æ¬¡Shifté”®æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®
            let shiftPressCount = 0;
            let shiftTimer = null;
            
            // æ–¹æ³•2: è¿ç»­æŒ‰3æ¬¡Ctrlé”®éšè—ç®¡ç†å‘˜æŒ‰é’®
            let ctrlPressCount = 0;
            let ctrlTimer = null;
            
            document.addEventListener('keydown', function(e) {
                // Shifté”® - æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®
                if (e.key === 'Shift') {
                    shiftPressCount++;
                    
                    if (shiftPressCount === 3) {
                        document.querySelector('.admin-controls').style.display = 'block';
                        console.log('âœ… ç®¡ç†å‘˜æ¨¡å¼å·²å¯ç”¨');
                        shiftPressCount = 0;
                    }
                    
                    clearTimeout(shiftTimer);
                    shiftTimer = setTimeout(() => {
                        shiftPressCount = 0;
                    }, 1000);
                }
                
                // Ctrlé”® - éšè—ç®¡ç†å‘˜æŒ‰é’®
                if (e.key === 'Control') {
                    ctrlPressCount++;
                    
                    if (ctrlPressCount === 3) {
                        const adminControls = document.querySelector('.admin-controls');
                        adminControls.style.display = 'none';
                        
                        // å¦‚æœæ­£åœ¨ç®¡ç†å‘˜æ¨¡å¼ï¼Œé€€å‡º
                        if (isAdminMode) {
                            toggleAdminMode();
                        }
                        
                        console.log('ğŸ”’ ç®¡ç†å‘˜æ¨¡å¼å·²éšè—');
                        ctrlPressCount = 0;
                    }
                    
                    clearTimeout(ctrlTimer);
                    ctrlTimer = setTimeout(() => {
                        ctrlPressCount = 0;
                    }, 1000);
                }
            });
            
            // æ–¹æ³•3: åœ¨æ§åˆ¶å°è¾“å…¥å‘½ä»¤
            window.showAdmin = function() {
                document.querySelector('.admin-controls').style.display = 'block';
                console.log('âœ… ç®¡ç†å‘˜æ¨¡å¼å·²å¯ç”¨');
            };
            
            window.hideAdmin = function() {
                const adminControls = document.querySelector('.admin-controls');
                adminControls.style.display = 'none';
                if (isAdminMode) {
                    toggleAdminMode();
                }
                console.log('ğŸ”’ ç®¡ç†å‘˜æ¨¡å¼å·²éšè—');
            };
            
            console.log('ğŸ’¡ æç¤º:');
            console.log('   - è¿ç»­æŒ‰3æ¬¡ Shift é”® â†’ æ˜¾ç¤ºç®¡ç†å‘˜æŒ‰é’®');
            console.log('   - è¿ç»­æŒ‰3æ¬¡ Ctrl é”® â†’ éšè—ç®¡ç†å‘˜æŒ‰é’®');
            console.log('   - æˆ–ä½¿ç”¨å‘½ä»¤: showAdmin() / hideAdmin()');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ¨¡å¼åˆ‡æ¢
            document.getElementById('mode-switch').addEventListener('click', toggleAdminMode);
            
            // åœ°å›¾ç‚¹å‡»
            mapContainer.addEventListener('click', handleMapClick);
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­tooltip
            document.addEventListener('click', function(e) {
                const tooltip = document.getElementById('tooltip');
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯tooltipå†…éƒ¨ï¼Œåˆ™å…³é—­tooltip
                if (!tooltip.contains(e.target) && tooltip.style.display === 'block') {
                    hideTooltip();
                }
            });
            
            // æŒ‰é’®äº‹ä»¶
            document.getElementById('update-marker-btn').addEventListener('click', updateMarker);
            document.getElementById('clear-btn').addEventListener('click', deleteRiskPoint);
            document.getElementById('save-all-btn').addEventListener('click', saveAllMarkers);
            
            
            // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
            const musicToggle = document.getElementById('music-toggle');
            const musicVolume = document.getElementById('music-volume');
            const backgroundMusic = document.getElementById('background-music');
            let isMusicPlaying = false;
            let audioContext = null;
            let backgroundSound = null;
            
            // åˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹
            function initBackgroundMusic() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„ç¯å¢ƒéŸ³æ•ˆ
                    function createTone(frequency, duration, delay = 0) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + delay);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0, audioContext.currentTime + delay);
                        gainNode.gain.linearRampToValueAtTime(0.05, audioContext.currentTime + delay + 0.1);
                        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + delay + duration);
                        
                        oscillator.start(audioContext.currentTime + delay);
                        oscillator.stop(audioContext.currentTime + delay + duration);
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªå¾ªç¯çš„èƒŒæ™¯éŸ³æ•ˆ
                    function playBackgroundLoop() {
                        if (!isMusicPlaying) return;
                        
                        // æ’­æ”¾ç®€å•çš„å’ŒéŸ³
                        createTone(220, 2, 0);    // A3
                        createTone(277, 2, 0.5);  // C#4
                        createTone(330, 2, 1);    // E4
                        createTone(440, 2, 1.5);  // A4
                        
                        // 8ç§’åé‡å¤
                        setTimeout(playBackgroundLoop, 8000);
                    }
                    
                    backgroundSound = { playBackgroundLoop };
                    
                } catch (error) {
                    console.log('Web Audio APIä¸æ”¯æŒï¼ŒèƒŒæ™¯éŸ³ä¹å°†ä¸å¯ç”¨');
                }
            }
            
            backgroundMusic.volume = 0.3;
            
            musicToggle.addEventListener('click', function() {
                if (isMusicPlaying) {
                    // åœæ­¢éŸ³ä¹
                    if (audioContext) {
                        audioContext.suspend();
                    }
                    musicToggle.textContent = 'ğŸµ';
                    isMusicPlaying = false;
                } else {
                    // å¼€å§‹éŸ³ä¹
                    if (!audioContext) {
                        initBackgroundMusic();
                    }
                    
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    musicToggle.textContent = 'ğŸ”‡';
                    isMusicPlaying = true;
                    
                    // å¼€å§‹æ’­æ”¾å¾ªç¯éŸ³æ•ˆ
                    if (backgroundSound) {
                        backgroundSound.playBackgroundLoop();
                    }
                }
            });
            
            musicVolume.addEventListener('input', function() {
                const volume = this.value / 100;
                backgroundMusic.volume = volume;
                
                // å¦‚æœä½¿ç”¨Web Audio APIï¼Œä¹Ÿè°ƒæ•´å…¨å±€éŸ³é‡
                if (audioContext && audioContext.destination) {
                    // Web Audio APIçš„éŸ³é¢‘ä¸Šä¸‹æ–‡éŸ³é‡è°ƒæ•´
                    audioContext.destination.volume = volume;
                }
            });
            
            // å¤šå›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
            
            document.getElementById('risk-image').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('image-preview');
                
                // é™åˆ¶æœ€å¤š10å¼ å›¾ç‰‡
                if (selectedImages.length + files.length > 10) {
                    alert('æœ€å¤šåªèƒ½ä¸Šä¼ 10å¼ å›¾ç‰‡ï¼');
                    return;
                }
                
                files.forEach((file, index) => {
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            selectedImages.push({
                                data: e.target.result,
                                file: file,
                                id: Date.now() + index
                            });
                            updateImagePreview();
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // æ¸…ç©ºinputï¼Œå…è®¸é‡æ–°é€‰æ‹©ç›¸åŒæ–‡ä»¶
                e.target.value = '';
            });
            
            
            // åœ°å›¾æ‹–æ‹½
            mapContainer.addEventListener('mousedown', handleMapMouseDown);
            document.addEventListener('mousemove', handleMapMouseMove);
            document.addEventListener('mouseup', handleMapMouseUp);
            
            // å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹æ¨¡æ€æ¡†
            const modal = document.getElementById('image-modal');
            const modalClose = document.getElementById('modal-close');
            
            modalClose.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘å…³é—­tooltip
                modal.style.display = 'none';
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘å…³é—­tooltip
                    modal.style.display = 'none';
                }
            });
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†ï¼ˆåªå…³é—­å›¾ç‰‡æ”¾å¤§ï¼Œä¸å…³é—­tooltipï¼‰
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                    modal.style.display = 'none';
                }
            });
            
            // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°æ ‡è®°ä½ç½®
            window.addEventListener('resize', function() {
                // ä½¿ç”¨é˜²æŠ–æ¥é¿å…é¢‘ç¹è°ƒç”¨
                clearTimeout(window.resizeTimeout);
                window.resizeTimeout = setTimeout(function() {
                    updateAllMarkerPositions();
                    console.log('çª—å£å¤§å°æ”¹å˜ï¼Œå·²æ›´æ–°æ‰€æœ‰æ ‡è®°ä½ç½®');
                }, 100);
            });
            
            // å›¾ç‰‡åŠ è½½å®Œæˆåæ›´æ–°æ ‡è®°ä½ç½®
            mapImage.addEventListener('load', function() {
                setTimeout(function() {
                    updateAllMarkerPositions();
                    console.log('å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²æ›´æ–°æ‰€æœ‰æ ‡è®°ä½ç½®');
                }, 100);
            });
            
        }
        
        // åˆ‡æ¢ç®¡ç†å‘˜æ¨¡å¼
        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            const container = document.getElementById('app-container');
            const modeBtn = document.getElementById('mode-switch');
            
            if (isAdminMode) {
                container.classList.remove('viewer-mode');
                container.classList.add('admin-mode');
                modeBtn.textContent = 'æŸ¥çœ‹è€…æ¨¡å¼';
                modeBtn.classList.add('admin');
                mapContainer.style.cursor = 'crosshair';
            } else {
                container.classList.remove('admin-mode');
                container.classList.add('viewer-mode');
                modeBtn.textContent = 'ç®¡ç†å‘˜æ¨¡å¼';
                modeBtn.classList.remove('admin');
                mapContainer.style.cursor = 'grab';
                
                // æ¸…é™¤é€‰æ‹©
                if (selectedMarker) {
                    selectedMarker.classList.remove('selected');
                    selectedMarker = null;
                }
                
                // æ¸…é™¤è¡¨å•
                document.getElementById('risk-title').value = '';
                document.getElementById('risk-description').value = '';
                document.getElementById('risk-type').value = '';
                document.getElementById('risk-data').value = '';
            }
            
            updateModeDisplay();
        }
        
        // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
        function updateModeDisplay() {
            const container = document.getElementById('app-container');
            if (isAdminMode) {
                container.classList.remove('viewer-mode');
                container.classList.add('admin-mode');
            } else {
                container.classList.remove('admin-mode');
                container.classList.add('viewer-mode');
            }
        }
        
        // åœ°å›¾æ‹–æ‹½å¼€å§‹
        function handleMapMouseDown(event) {
            // åªåœ¨éç¼–è¾‘æ¨¡å¼æˆ–è€…ç‚¹å‡»çš„ä¸æ˜¯æ ‡è®°æ—¶æ‰å¯ç”¨æ‹–æ‹½
            if (event.target === mapImage || event.target === mapContainer) {
                isDragging = true;
                mapContainer.classList.add('dragging');
                dragStartX = event.clientX;
                dragStartY = event.clientY;
                scrollLeft = mapContainer.scrollLeft;
                scrollTop = mapContainer.scrollTop;
                event.preventDefault();
            }
        }
        
        // åœ°å›¾æ‹–æ‹½ç§»åŠ¨
        function handleMapMouseMove(event) {
            if (isDragging) {
                const deltaX = event.clientX - dragStartX;
                const deltaY = event.clientY - dragStartY;
                
                mapContainer.scrollLeft = scrollLeft - deltaX;
                mapContainer.scrollTop = scrollTop - deltaY;
            }
        }
        
        // åœ°å›¾æ‹–æ‹½ç»“æŸ
        function handleMapMouseUp(event) {
            if (isDragging) {
                isDragging = false;
                mapContainer.classList.remove('dragging');
            }
        }
        
        // åæ ‡è½¬æ¢å‡½æ•°ï¼šä»å±å¹•åæ ‡è½¬æ¢ä¸ºå›¾ç‰‡ç›¸å¯¹åæ ‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        function screenToImageCoords(screenX, screenY) {
            const rect = mapImage.getBoundingClientRect();
            const relativeX = screenX - rect.left;
            const relativeY = screenY - rect.top;
            
            // è½¬æ¢ä¸ºå›¾ç‰‡åŸå§‹å°ºå¯¸çš„ç™¾åˆ†æ¯”åæ ‡
            const imageNaturalWidth = mapImage.naturalWidth;
            const imageNaturalHeight = mapImage.naturalHeight;
            const imageDisplayWidth = rect.width;
            const imageDisplayHeight = rect.height;
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scaleX = imageNaturalWidth / imageDisplayWidth;
            const scaleY = imageNaturalHeight / imageDisplayHeight;
            
            // è½¬æ¢ä¸ºåŸå§‹å›¾ç‰‡åæ ‡ï¼Œç„¶åè½¬æ¢ä¸ºç™¾åˆ†æ¯”
            const originalX = relativeX * scaleX;
            const originalY = relativeY * scaleY;
            
            const percentX = (originalX / imageNaturalWidth) * 100;
            const percentY = (originalY / imageNaturalHeight) * 100;
            
            return {
                percentX: Math.max(0, Math.min(100, percentX)),
                percentY: Math.max(0, Math.min(100, percentY)),
                originalX: originalX,
                originalY: originalY
            };
        }
        
        // åæ ‡è½¬æ¢å‡½æ•°ï¼šä»å›¾ç‰‡ç›¸å¯¹åæ ‡ï¼ˆç™¾åˆ†æ¯”ï¼‰è½¬æ¢ä¸ºå±å¹•åæ ‡
        function imageToScreenCoords(percentX, percentY) {
            const rect = mapImage.getBoundingClientRect();
            const imageNaturalWidth = mapImage.naturalWidth;
            const imageNaturalHeight = mapImage.naturalHeight;
            
            // ä»ç™¾åˆ†æ¯”è½¬æ¢ä¸ºåŸå§‹å›¾ç‰‡åæ ‡
            const originalX = (percentX / 100) * imageNaturalWidth;
            const originalY = (percentY / 100) * imageNaturalHeight;
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scaleX = rect.width / imageNaturalWidth;
            const scaleY = rect.height / imageNaturalHeight;
            
            // è½¬æ¢ä¸ºå½“å‰æ˜¾ç¤ºåæ ‡
            const screenX = originalX * scaleX;
            const screenY = originalY * scaleY;
            
            return {
                x: screenX,
                y: screenY
            };
        }
        
        // å¤„ç†åœ°å›¾ç‚¹å‡»
        function handleMapClick(event) {
            if (!isAdminMode || isDragging) return;
            
            // é˜²æ­¢åœ¨æ‹–æ‹½æ—¶åˆ›å»ºæ ‡è®°
            if (event.target !== mapImage && event.target !== mapContainer) return;
            
            // æ£€æŸ¥å¿…å¡«å­—æ®µ
            const title = document.getElementById('risk-title').value.trim();
            const description = document.getElementById('risk-description').value.trim();
            const type = document.getElementById('risk-type').value.trim();
            const data = document.getElementById('risk-data').value.trim();
            const imageInput = document.getElementById('risk-image');
            let imageData = null;
            
            if (!title || !description) {
                // é«˜äº®æç¤ºå¿…å¡«å­—æ®µ
                const titleInput = document.getElementById('risk-title');
                const descInput = document.getElementById('risk-description');
                
                if (!title) {
                    titleInput.style.border = '2px solid #e74c3c';
                    titleInput.focus();
                }
                if (!description) {
                    descInput.style.border = '2px solid #e74c3c';
                    if (!title) {
                        setTimeout(() => descInput.focus(), 100);
                    } else {
                        descInput.focus();
                    }
                }
                
                // 3ç§’åæ¢å¤è¾¹æ¡†
                setTimeout(() => {
                    titleInput.style.border = '';
                    descInput.style.border = '';
                }, 3000);
                
                alert('è¯·å…ˆå¡«å†™åœ°ç‚¹åç§°å’Œæ•°å­—ç”Ÿå­˜æŒ‡å—ï¼');
                console.log('æœªå¡«å†™å¿…å¡«ä¿¡æ¯ï¼Œæ— æ³•æ·»åŠ æ ‡è®°');
                return;
            }
            
            // è·å–å¤šå›¾ç‰‡æ•°æ®
            const imageDataArray = selectedImages.map(img => img.data);
            addMarkerWithData();
            
            async function addMarkerWithData() {
                // ä½¿ç”¨æ–°çš„åæ ‡è½¬æ¢ç³»ç»Ÿ
                const coords = screenToImageCoords(event.clientX, event.clientY);
                
                // ç›´æ¥æ·»åŠ æ ‡è®°ï¼Œå­˜å‚¨ç™¾åˆ†æ¯”åæ ‡ï¼Œä¼ é€’å¤šå›¾ç‰‡æ•°æ®
                addRiskPoint(coords.percentX, coords.percentY, type, title, description, null, data, imageDataArray);
            
                // æ¸…é™¤è¡¨å•
                document.getElementById('risk-title').value = '';
                document.getElementById('risk-description').value = '';
                document.getElementById('risk-type').value = '';
                document.getElementById('risk-data').value = '';
                document.getElementById('risk-image').value = '';
                document.getElementById('image-preview').innerHTML = '';
                
                // æ¸…é™¤é€‰ä¸­çš„å›¾ç‰‡æ•°ç»„
                selectedImages = [];
                
                // æ›´æ–°æ•°æ®ç‚¹åˆ—è¡¨
                updateRiskList();
                
                // è‡ªåŠ¨ä¿å­˜æ•°æ®
                try {
                    await saveData();
                    console.log('æ ‡è®°å·²æ·»åŠ :', title, 'ä½ç½®:', coords.percentX, coords.percentY);
                } catch (error) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                }
            }
        }
        
        // åˆ›å»ºä¸´æ—¶æ ‡è®°
        function createTempMarker(percentX, percentY, type = 'high') {
            // å…ˆæ¸…é™¤ä¹‹å‰çš„ä¸´æ—¶æ ‡è®°
            const oldTemp = document.querySelector('[data-temp="true"]');
            if (oldTemp) {
                oldTemp.remove();
                console.log('ç§»é™¤æ—§çš„ä¸´æ—¶æ ‡è®°');
            }
            
            const marker = document.createElement('div');
            marker.className = `risk-marker low selected`; // ç»Ÿä¸€ä½¿ç”¨ç»¿è‰²æ ·å¼
            
            // å°†ç™¾åˆ†æ¯”åæ ‡è½¬æ¢ä¸ºå½“å‰å±å¹•åæ ‡
            const screenCoords = imageToScreenCoords(percentX, percentY);
            
            marker.style.left = screenCoords.x + 'px';
            marker.style.top = screenCoords.y + 'px';
            marker.dataset.temp = 'true';
            marker.dataset.percentX = percentX;
            marker.dataset.percentY = percentY;
            marker.dataset.x = percentX; // ä¿æŒå‘åå…¼å®¹
            marker.dataset.y = percentY;
            marker.dataset.type = type;
            
            // ä¸´æ—¶æ ‡è®°ä¸æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä¸ä¼šè¢«æ·»åŠ åˆ°riskPoints
            
            markersContainer.appendChild(marker);
            selectedMarker = marker;
            console.log('åˆ›å»ºä¸´æ—¶æ ‡è®°ï¼Œç±»å‹:', type, 'ç­‰å¾…å¡«å†™ä¿¡æ¯');
        }
        
        // æ·»åŠ æ•°æ®ç‚¹
        function addRiskPoint(percentX, percentY, type, title, description, id = null, data = '', imageData = null) {
            // å¤„ç†å¤šå›¾ç‰‡æ•°æ®ï¼šå¦‚æœæ˜¯æ•°ç»„åˆ™ä¿æŒï¼Œå¦‚æœæ˜¯å•ä¸ªæ•°æ®åˆ™è½¬æ¢ä¸ºæ•°ç»„
            let imageDataArray = [];
            if (imageData) {
                if (Array.isArray(imageData)) {
                    imageDataArray = imageData;
                } else {
                    imageDataArray = [imageData];
                }
            }
            const marker = document.createElement('div');
            marker.className = `risk-marker low`; // ç»Ÿä¸€ä½¿ç”¨ç»¿è‰²æ ·å¼
            
            // å°†ç™¾åˆ†æ¯”åæ ‡è½¬æ¢ä¸ºå½“å‰å±å¹•åæ ‡ç”¨äºæ˜¾ç¤º
            const screenCoords = imageToScreenCoords(percentX, percentY);
            
            marker.style.left = screenCoords.x + 'px';
            marker.style.top = screenCoords.y + 'px';
            marker.dataset.id = id || Date.now() + Math.random();
            marker.dataset.percentX = percentX; // å­˜å‚¨ç™¾åˆ†æ¯”åæ ‡
            marker.dataset.percentY = percentY;
            marker.dataset.x = percentX; // ä¿æŒå‘åå…¼å®¹
            marker.dataset.y = percentY;
            
            // ç‚¹å‡»äº‹ä»¶
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                // console.log('æ ‡è®°è¢«ç‚¹å‡»ï¼Œç®¡ç†å‘˜æ¨¡å¼:', isAdminMode);
                if (isAdminMode) {
                    selectMarker(marker);
                } else {
                    // æŸ¥çœ‹æ¨¡å¼ä¸‹ç‚¹å‡»æ˜¾ç¤ºä¿¡æ¯å¡ç‰‡
                    showTooltip(marker, e);
                }
            });
            
            markersContainer.appendChild(marker);
            
            // å­˜å‚¨æ•°æ®ç‚¹æ•°æ®
            const riskPoint = {
                id: id || Date.now() + Math.random(),
                type: type,
                title: title,
                description: description,
                data: data || '',
                imageData: imageDataArray, // å­˜å‚¨å¤šå›¾ç‰‡æ•°ç»„
                x: percentX, // å­˜å‚¨ç™¾åˆ†æ¯”åæ ‡
                y: percentY,
                percentX: percentX, // æ˜ç¡®çš„ç™¾åˆ†æ¯”åæ ‡å­—æ®µ
                percentY: percentY,
                marker: marker
            };
            
            riskPoints.push(riskPoint);
            return riskPoint;
        }
        
        // æ›´æ–°æ‰€æœ‰æ ‡è®°çš„ä½ç½®ï¼ˆå½“çª—å£å¤§å°æ”¹å˜æˆ–å›¾ç‰‡ç¼©æ”¾æ—¶è°ƒç”¨ï¼‰
        function updateAllMarkerPositions() {
            // æ›´æ–°æ‰€æœ‰æ­£å¼æ ‡è®°
            riskPoints.forEach(riskPoint => {
                if (riskPoint.marker && riskPoint.percentX !== undefined && riskPoint.percentY !== undefined) {
                    const screenCoords = imageToScreenCoords(riskPoint.percentX, riskPoint.percentY);
                    riskPoint.marker.style.left = screenCoords.x + 'px';
                    riskPoint.marker.style.top = screenCoords.y + 'px';
                }
            });
            
            // æ›´æ–°ä¸´æ—¶æ ‡è®°
            const tempMarker = document.querySelector('[data-temp="true"]');
            if (tempMarker && tempMarker.dataset.percentX && tempMarker.dataset.percentY) {
                const screenCoords = imageToScreenCoords(
                    parseFloat(tempMarker.dataset.percentX), 
                    parseFloat(tempMarker.dataset.percentY)
                );
                tempMarker.style.left = screenCoords.x + 'px';
                tempMarker.style.top = screenCoords.y + 'px';
            }
        }
        
        // é€‰æ‹©æ ‡è®°
        function selectMarker(marker) {
            console.log('selectMarkerè¢«è°ƒç”¨, marker:', marker);
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            if (selectedMarker) {
                selectedMarker.classList.remove('selected');
                console.log('æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©');
            }
            
            // è®¾ç½®æ–°é€‰æ‹©
            selectedMarker = marker;
            marker.classList.add('selected');
            console.log('æ ‡è®°å·²æ·»åŠ selectedç±»');
            
            // æ˜¾ç¤ºæ›´æ–°æŒ‰é’®
            document.getElementById('update-marker-btn').style.display = 'inline-block';
            
            // å¡«å……è¡¨å•
            const riskPoint = getRiskPointByMarker(marker);
            console.log('æ‰¾åˆ°çš„æ•°æ®ç‚¹:', riskPoint);
            if (riskPoint) {
                document.getElementById('risk-title').value = riskPoint.title;
                document.getElementById('risk-type').value = riskPoint.type || '';
                document.getElementById('risk-data').value = riskPoint.data || '';
                document.getElementById('risk-description').value = riskPoint.description;
                
                // æ˜¾ç¤ºå¤šå›¾ç‰‡é¢„è§ˆ
                const preview = document.getElementById('image-preview');
                updateSelectedImagesFromRiskPoint(riskPoint);
                
                console.log('è¡¨å•å·²å¡«å……');
            }
        }
        
        // æ ¹æ®æ ‡è®°è·å–æ•°æ®ç‚¹
        function getRiskPointByMarker(marker) {
            return riskPoints.find(point => point.marker === marker);
        }
        
        // å…¨å±€å‡½æ•°ï¼šæ›´æ–°å›¾ç‰‡é¢„è§ˆæ˜¾ç¤º
        function updateImagePreview() {
            const preview = document.getElementById('image-preview');
            console.log('updateImagePreviewè¢«è°ƒç”¨ï¼Œpreviewå…ƒç´ :', preview);
            console.log('å½“å‰selectedImages:', selectedImages);
            
            if (!preview) {
                console.log('æœªæ‰¾åˆ°image-previewå…ƒç´ ');
                return;
            }
            
            preview.innerHTML = '';
            
            selectedImages.forEach((image, index) => {
                console.log('æ·»åŠ å›¾ç‰‡é¢„è§ˆ:', index, image);
                const imageDiv = document.createElement('div');
                imageDiv.className = 'preview-image';
                
                // åˆ›å»ºå›¾ç‰‡å…ƒç´ ï¼Œé¿å…HTMLè½¬ä¹‰é—®é¢˜
                const img = document.createElement('img');
                
                // éªŒè¯å›¾ç‰‡æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                if (image.data && typeof image.data === 'string' && image.data.trim().length > 0) {
                    const trimmed = image.data.trim();
                    const isValidImageData = trimmed.startsWith('data:image/') || 
                                           trimmed.startsWith('data:') || 
                                           trimmed.startsWith('http://') || 
                                           trimmed.startsWith('https://') || 
                                           trimmed.startsWith('blob:') ||
                                           trimmed.includes('/9j/') || 
                                           trimmed.includes('iVBORw0KGgo');
                    
                    if (isValidImageData) {
                        img.src = image.data;
                        console.log('é¢„è§ˆè®¾ç½®å›¾ç‰‡src:', image.data.substring(0, 50) + '...');
                        
                        // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢åŠ è½½å¤±è´¥
                        img.onerror = function() {
                            console.error('é¢„è§ˆå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œéšè—è¯¥å›¾ç‰‡:', image.data.substring(0, 50) + '...');
                            img.style.display = 'none';
                        };
                    } else {
                        console.warn('é¢„è§ˆï¼šæ— æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼Œè·³è¿‡è®¾ç½®src:', image.data.substring(0, 50) + '...');
                        img.style.display = 'none'; // éšè—æ— æ•ˆå›¾ç‰‡
                    }
                } else {
                    console.warn('é¢„è§ˆï¼šç©ºçš„æˆ–æ— æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼Œè·³è¿‡è®¾ç½®src');
                    img.style.display = 'none'; // éšè—æ— æ•ˆå›¾ç‰‡
                }
                
                img.alt = 'é¢„è§ˆå›¾ç‰‡';
                
                // åˆ›å»ºåˆ é™¤æŒ‰é’®
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Ã—';
                removeBtn.setAttribute('data-image-id', image.id);
                
                // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                removeBtn.addEventListener('click', function() {
                    const imageId = parseInt(this.getAttribute('data-image-id'));
                    removeImage(imageId);
                });
                
                imageDiv.appendChild(img);
                imageDiv.appendChild(removeBtn);
                preview.appendChild(imageDiv);
            });
            
            console.log('å›¾ç‰‡é¢„è§ˆæ›´æ–°å®Œæˆï¼Œå…±', selectedImages.length, 'å¼ å›¾ç‰‡');
        }
        
        // å…¨å±€å‡½æ•°ï¼šç§»é™¤å›¾ç‰‡
        window.removeImage = function(imageId) {
            selectedImages = selectedImages.filter(img => img.id !== imageId);
            updateImagePreview();
        };
        
        // ä»æ•°æ®ç‚¹æ•°æ®æ›´æ–°é€‰ä¸­çš„å›¾ç‰‡æ•°ç»„
        function updateSelectedImagesFromRiskPoint(riskPoint) {
            console.log('updateSelectedImagesFromRiskPointè¢«è°ƒç”¨ï¼ŒriskPoint:', riskPoint);
            selectedImages = [];
            
            if (riskPoint.imageData) {
                console.log('æ‰¾åˆ°å›¾ç‰‡æ•°æ®ï¼Œç±»å‹:', typeof riskPoint.imageData, 'æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(riskPoint.imageData), 'åŸå§‹æ•°æ®:', riskPoint.imageData);
                
                // å…ˆä¿®å¤å¯èƒ½è¢«å¤šæ¬¡åºåˆ—åŒ–çš„æ•°æ®
                const fixedImageData = fixSerializedImageData(riskPoint.imageData);
                console.log('ä¿®å¤åçš„å›¾ç‰‡æ•°æ®:', fixedImageData);
                
                let imagesToShow = [];
                
                // å¤„ç†ä¸åŒç±»å‹çš„å›¾ç‰‡æ•°æ®
                if (Array.isArray(fixedImageData)) {
                    console.log('å›¾ç‰‡æ•°æ®æ˜¯æ•°ç»„ï¼Œé•¿åº¦:', fixedImageData.length);
                    imagesToShow = fixedImageData;
                } else if (typeof fixedImageData === 'string') {
                    console.log('å›¾ç‰‡æ•°æ®æ˜¯å­—ç¬¦ä¸²ï¼Œé•¿åº¦:', fixedImageData.length);
                    // å¦‚æœæ˜¯å•ä¸ªå­—ç¬¦ä¸²ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„base64æˆ–URL
                    if (fixedImageData.trim().length > 0) {
                        imagesToShow = [fixedImageData];
                        console.log('å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„:', imagesToShow);
                    }
                }
                
                // è¿‡æ»¤æœ‰æ•ˆå›¾ç‰‡
                console.log('å¼€å§‹è¿‡æ»¤å›¾ç‰‡ï¼ŒåŸå§‹æ•°é‡:', imagesToShow.length);
                imagesToShow = imagesToShow.filter((img, index) => {
                    console.log(`è¿‡æ»¤å›¾ç‰‡ ${index}:`, typeof img, img ? img.substring(0, 50) + '...' : 'null');
                    
                    if (!img || typeof img !== 'string') {
                        console.log(`å›¾ç‰‡ ${index} è¢«è¿‡æ»¤ï¼šä¸æ˜¯æœ‰æ•ˆå­—ç¬¦ä¸²`);
                        return false;
                    }
                    
                    const trimmed = img.trim();
                    if (trimmed.length === 0) {
                        console.log(`å›¾ç‰‡ ${index} è¢«è¿‡æ»¤ï¼šç©ºå­—ç¬¦ä¸²`);
                        return false;
                    }
                    
                    // æ£€æŸ¥å„ç§æ ¼å¼
                    const isValid = trimmed.startsWith('data:image/') ||  // æ ‡å‡†base64å›¾ç‰‡
                                   trimmed.startsWith('data:') ||        // ä»»ä½•base64æ•°æ®
                                   trimmed.startsWith('http://') ||     // HTTP URL
                                   trimmed.startsWith('https://') ||    // HTTPS URL
                                   trimmed.startsWith('blob:') ||       // Blob URL
                                   trimmed.includes('/9j/') ||          // JPEG base64ç‰¹å¾
                                   trimmed.includes('iVBORw0KGgo');    // PNG base64ç‰¹å¾
                    
                    console.log(`å›¾ç‰‡ ${index} éªŒè¯ç»“æœ:`, isValid, 'å‰100å­—ç¬¦:', trimmed.substring(0, 100));
                    return isValid;
                });
                
                console.log('è¿‡æ»¤åçš„å›¾ç‰‡æ•°é‡:', imagesToShow.length);
                console.log('è¿‡æ»¤åçš„å›¾ç‰‡æ•°æ®:', imagesToShow);
                
                selectedImages = imagesToShow.map((imgData, index) => ({
                    data: imgData.trim(),
                    id: Date.now() + index
                }));
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ•°æ®');
            }
            
            console.log('æ›´æ–°åçš„selectedImages:', selectedImages);
            updateImagePreview();
        }
        
        // æ˜¾ç¤ºæç¤ºæ¡†
        function showTooltip(marker, event) {
            const riskPoint = getRiskPointByMarker(marker);
            if (!riskPoint) return;
            
            let imagesToShow = []; // å£°æ˜åœ¨å‡½æ•°ä½œç”¨åŸŸ
            
            let html = `<h4>æ•°æ®å¡ç‰‡</h4>`;
            
            // åœ°ç‚¹ï¼ˆç¬¬ä¸€ä½ï¼‰
            html += `
                <div class="tooltip-row">
                    <div class="tooltip-label">åœ°ç‚¹ï¼š</div>
                    <div class="tooltip-value">${riskPoint.title}</div>
                </div>
            `;
            
            // æµ‹é‡æ–¹æ³•ï¼ˆå¦‚æœæœ‰ï¼‰
            if (riskPoint.type && riskPoint.type.trim()) {
                html += `
                    <div class="tooltip-row">
                        <div class="tooltip-label">æµ‹é‡æ–¹æ³•ï¼š</div>
                        <div class="tooltip-value">${riskPoint.type}</div>
                    </div>
                `;
            }
            
            // æµ‹é‡å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
            if (riskPoint.data && riskPoint.data.trim()) {
                html += `
                    <div class="tooltip-row">
                        <div class="tooltip-label">æµ‹é‡å€¼ï¼š</div>
                        <div class="tooltip-value" style="white-space: pre-line;">${riskPoint.data}</div>
                    </div>
                `;
            }
            
            // æ•°å­—ç”Ÿå­˜æŒ‡å—
            html += `
                <div class="tooltip-row">
                    <div class="tooltip-label">æ•°å­—ç”Ÿå­˜æŒ‡å—ï¼š</div>
                    <div class="tooltip-value">${riskPoint.description}</div>
                </div>
            `;
            
            // å®æ™¯å›¾ç‰‡ï¼ˆæ”¯æŒå¤šå¼ ï¼‰
            if (riskPoint.imageData) {
                // å…ˆä¿®å¤å¯èƒ½è¢«å¤šæ¬¡åºåˆ—åŒ–çš„æ•°æ®
                const fixedImageData = fixSerializedImageData(riskPoint.imageData);
                console.log('showTooltipä¿®å¤å›¾ç‰‡æ•°æ®:', fixedImageData);
                
                // ä½¿ç”¨ä¸updateSelectedImagesFromRiskPointç›¸åŒçš„è¿‡æ»¤é€»è¾‘
                if (Array.isArray(fixedImageData)) {
                    imagesToShow = fixedImageData;
                } else if (typeof fixedImageData === 'string') {
                    if (fixedImageData.trim().length > 0) {
                        imagesToShow = [fixedImageData];
                    }
                }
                
                // è¿‡æ»¤æœ‰æ•ˆå›¾ç‰‡ - ä½¿ç”¨ä¸updateSelectedImagesFromRiskPointç›¸åŒçš„å®½æ¾éªŒè¯
                imagesToShow = imagesToShow.filter(img => {
                    if (!img || typeof img !== 'string') return false;
                    const trimmed = img.trim();
                    if (trimmed.length === 0) return false;
                    
                    // æ›´å®½æ¾çš„éªŒè¯ï¼šæ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼
                    return trimmed.startsWith('data:image/') ||  // æ ‡å‡†base64å›¾ç‰‡
                           trimmed.startsWith('data:') ||        // ä»»ä½•base64æ•°æ®
                           trimmed.startsWith('http://') ||     // HTTP URL
                           trimmed.startsWith('https://') ||    // HTTPS URL
                           trimmed.startsWith('blob:') ||       // Blob URL
                           trimmed.includes('/9j/') ||          // JPEG base64ç‰¹å¾
                           trimmed.includes('iVBORw0KGgo');    // PNG base64ç‰¹å¾
                });
                
                if (imagesToShow.length > 0) {
                    if (imagesToShow.length === 1) {
                        // å•å¼ å›¾ç‰‡ç›´æ¥æ˜¾ç¤ºï¼Œä½†è¦ç¡®ä¿ä¸è¶…å‡ºå¡ç‰‡
                        html += `<img src="" alt="å®æ™¯å›¾ç‰‡" class="tooltip-image" data-image-src="">`;
                    } else {
                        // å¤šå¼ å›¾ç‰‡ä½¿ç”¨æ»šåŠ¨å®¹å™¨
                        html += `<div class="tooltip-label" style="margin-bottom: 10px; margin-top: 15px;">å®æ™¯å›¾ç‰‡ (${imagesToShow.length}å¼ )ï¼š</div>`;
                        html += `<div id="tooltip-images-container">`;
                        imagesToShow.forEach((imgSrc, index) => {
                            html += `<img src="" alt="å®æ™¯å›¾ç‰‡${index + 1}" class="tooltip-image" data-image-src="">`;
                        });
                        html += `</div>`;
                    }
                }
            }
            
            tooltip.innerHTML = html;
            
            // ä¸ºå›¾ç‰‡è®¾ç½®srcå’Œdata-image-srcå±æ€§ï¼Œé¿å…HTMLè½¬ä¹‰é—®é¢˜
            const tooltipImages = tooltip.querySelectorAll('.tooltip-image');
            tooltipImages.forEach((img, index) => {
                if (imagesToShow && imagesToShow[index]) {
                    const imageData = imagesToShow[index];
                    // éªŒè¯å›¾ç‰‡æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                    if (imageData && typeof imageData === 'string' && imageData.trim().length > 0) {
                        // è¿›ä¸€æ­¥éªŒè¯å›¾ç‰‡æ•°æ®æ ¼å¼
                        const trimmed = imageData.trim();
                        const isValidImageData = trimmed.startsWith('data:image/') || 
                                               trimmed.startsWith('data:') || 
                                               trimmed.startsWith('http://') || 
                                               trimmed.startsWith('https://') || 
                                               trimmed.startsWith('blob:') ||
                                               trimmed.includes('/9j/') || 
                                               trimmed.includes('iVBORw0KGgo');
                        
                        if (isValidImageData) {
                            img.src = imageData;
                            img.setAttribute('data-image-src', imageData);
                            console.log('è®¾ç½®å›¾ç‰‡src:', imageData.substring(0, 50) + '...');
                            
                            // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢åŠ è½½å¤±è´¥
                            img.onerror = function() {
                                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œéšè—è¯¥å›¾ç‰‡:', imageData.substring(0, 50) + '...');
                                img.style.display = 'none';
                            };
                        } else {
                            console.warn('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼Œè·³è¿‡è®¾ç½®src:', imageData.substring(0, 50) + '...');
                            img.style.display = 'none'; // éšè—æ— æ•ˆå›¾ç‰‡
                        }
                    } else {
                        console.warn('ç©ºçš„æˆ–æ— æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼Œè·³è¿‡è®¾ç½®src');
                        img.style.display = 'none'; // éšè—æ— æ•ˆå›¾ç‰‡
                    }
                }
            });
            
            // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶å’Œå“åº”å¼å°ºå¯¸è°ƒæ•´
            tooltipImages.forEach(img => {
                img.addEventListener('click', function() {
                    const imageSrc = this.getAttribute('data-image-src');
                    showImageModal(imageSrc);
                });
                
                // ç±»ä¼¼rpxçš„å“åº”å¼è°ƒæ•´ï¼šåŸºäºå±å¹•å®½åº¦ï¼Œä½†é™åˆ¶åœ¨å¡ç‰‡å†…
                function adjustImageSize() {
                    const screenWidth = window.innerWidth;
                    // è·å–å¡ç‰‡å®¹å™¨ï¼Œç”¨äºè®¡ç®—æœ€å¤§å…è®¸å®½åº¦
                    const tooltipContainer = img.closest('.risk-tooltip');
                    const containerMaxWidth = tooltipContainer ? tooltipContainer.clientWidth - 40 : 360; // å‡å»padding
                    
                    // å‡è®¾è®¾è®¡ç¨¿åŸºäº750pxå®½åº¦ï¼Œç±»ä¼¼å°ç¨‹åºrpx
                    const rpxRatio = screenWidth / 750;
                    const baseWidth = 150;
                    const baseHeight = 120;
                    
                    // è®¡ç®—ç†æƒ³å°ºå¯¸
                    let idealWidth = baseWidth * rpxRatio;
                    let idealHeight = baseHeight * rpxRatio;
                    
                    // ç¡®ä¿å›¾ç‰‡ä¸ä¼šè¶…å‡ºå¡ç‰‡å®½åº¦
                    if (idealWidth > containerMaxWidth) {
                        const scaleFactor = containerMaxWidth / idealWidth;
                        idealWidth = containerMaxWidth;
                        idealHeight = idealHeight * scaleFactor;
                    }
                    
                    // åº”ç”¨è®¡ç®—åçš„å°ºå¯¸
                    img.style.width = `${Math.min(idealWidth, 150)}px`; // æœ€å¤§ä¸è¶…è¿‡150px
                    img.style.height = `${Math.min(idealHeight, 120)}px`; // æœ€å¤§ä¸è¶…è¿‡120px
                }
                
                // åˆå§‹è°ƒæ•´å’Œçª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´
                adjustImageSize();
                window.addEventListener('resize', adjustImageSize);
            });
            
            tooltip.style.left = event.clientX + 15 + 'px';
            tooltip.style.top = event.clientY - 15 + 'px';
            tooltip.style.display = 'block';
            
            // é˜»æ­¢tooltipå†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
            tooltip.onclick = function(e) {
                e.stopPropagation();
            };
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡†
        function showImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            // éªŒè¯å›¾ç‰‡æ•°æ®æ˜¯å¦æœ‰æ•ˆ
            if (imageSrc && typeof imageSrc === 'string' && imageSrc.trim().length > 0) {
                const trimmed = imageSrc.trim();
                const isValidImageData = trimmed.startsWith('data:image/') || 
                                       trimmed.startsWith('data:') || 
                                       trimmed.startsWith('http://') || 
                                       trimmed.startsWith('https://') || 
                                       trimmed.startsWith('blob:') ||
                                       trimmed.includes('/9j/') || 
                                       trimmed.includes('iVBORw0KGgo');
                
                if (isValidImageData) {
                    modalImage.src = imageSrc;
                    modal.style.display = 'flex';
                    console.log('æ¨¡æ€æ¡†è®¾ç½®å›¾ç‰‡src:', imageSrc.substring(0, 50) + '...');
                    
                    // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œé˜²æ­¢åŠ è½½å¤±è´¥
                    modalImage.onerror = function() {
                        console.error('æ¨¡æ€æ¡†å›¾ç‰‡åŠ è½½å¤±è´¥:', imageSrc.substring(0, 50) + '...');
                        modal.style.display = 'none';
                        alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ— æ³•æ˜¾ç¤ºæ”¾å¤§å›¾ç‰‡');
                    };
                } else {
                    console.warn('æ¨¡æ€æ¡†ï¼šæ— æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼Œæ— æ³•æ˜¾ç¤º:', imageSrc.substring(0, 50) + '...');
                    return; // ä¸æ˜¾ç¤ºæ¨¡æ€æ¡†
                }
            } else {
                console.warn('æ¨¡æ€æ¡†ï¼šç©ºçš„æˆ–æ— æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼Œæ— æ³•æ˜¾ç¤º');
                return; // ä¸æ˜¾ç¤ºæ¨¡æ€æ¡†
            }
        }
        
        // éšè—æç¤ºæ¡†
        function hideTooltip() {
            tooltip.style.display = 'none';
        }
        
        // æ›´æ–°ç°æœ‰æ ‡è®°
        function updateMarker() {
            const title = document.getElementById('risk-title').value.trim();
            const description = document.getElementById('risk-description').value.trim();
            const type = document.getElementById('risk-type').value.trim();
            const data = document.getElementById('risk-data').value.trim();
            const imageInput = document.getElementById('risk-image');
            
            if (!title || !description) {
                alert('è¯·å¡«å†™åœ°ç‚¹åç§°å’Œæ•°å­—ç”Ÿå­˜æŒ‡å—ï¼');
                return;
            }
            
            if (!selectedMarker || selectedMarker.dataset.temp === 'true') {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå·²æœ‰æ ‡è®°ï¼');
                return;
            }
            
                // æ›´æ–°ç°æœ‰æ ‡è®°
                const riskPoint = getRiskPointByMarker(selectedMarker);
                if (riskPoint) {
                    riskPoint.title = title;
                    riskPoint.type = type;
                    riskPoint.data = data;
                    riskPoint.description = description;
                    
                // æ›´æ–°å›¾ç‰‡æ•°æ®ï¼šä½¿ç”¨å½“å‰é€‰ä¸­çš„å›¾ç‰‡æ•°ç»„
                riskPoint.imageData = selectedImages.map(img => img.data);
                finishUpdate();
                
                async function finishUpdate() {
                    // æ›´æ–°æ ‡è®°æ ·å¼
                    selectedMarker.className = `risk-marker low selected`; // ç»Ÿä¸€ä½¿ç”¨ç»¿è‰²æ ·å¼
                    
                    // æ›´æ–°æ•°æ®ç‚¹åˆ—è¡¨
                    updateRiskList();
                    
                    // è‡ªåŠ¨ä¿å­˜æ•°æ®
                    try {
                        await saveData();
                        alert('æ ‡è®°å·²æ›´æ–°æˆåŠŸï¼');
                        console.log('æ ‡è®°å·²æ›´æ–°');
                    } catch (error) {
                        console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                        alert('æ ‡è®°å·²æ›´æ–°ï¼Œä½†ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                }
            }
        }
        
        // ä¿å­˜æ‰€æœ‰æ ‡è®°åˆ°æ•°æ®åº“
        async function saveAllMarkers() {
            console.log('ä¿å­˜æ‰€æœ‰æ ‡è®°ï¼Œå½“å‰æ ‡è®°æ•°é‡:', riskPoints.length);
            console.log('æ ‡è®°è¯¦æƒ…:', riskPoints);
            
            if (riskPoints.length === 0) {
                alert('æ²¡æœ‰æ ‡è®°éœ€è¦ä¿å­˜ï¼è¯·å…ˆæ·»åŠ æ ‡è®°ã€‚');
                return;
            }
            
            try {
                // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
                const saveBtn = document.getElementById('save-all-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'æ­£åœ¨ä¿å­˜...';
                saveBtn.disabled = true;
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await saveData();
                
                alert(`âœ… å·²æˆåŠŸä¿å­˜ ${riskPoints.length} ä¸ªæ ‡è®°åˆ°æ•°æ®åº“ï¼`);
                console.log(`âœ… æ•°æ®å·²ä¿å­˜ï¼Œå…± ${riskPoints.length} ä¸ªæ ‡è®°ç‚¹`);
                
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                alert(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const saveBtn = document.getElementById('save-all-btn');
                saveBtn.textContent = 'ä¿å­˜æ‰€æœ‰æ ‡è®°';
                saveBtn.disabled = false;
            }
        }
        
        // åˆ é™¤æ•°æ®ç‚¹
        async function deleteRiskPoint() {
            console.log('deleteRiskPointè¢«è°ƒç”¨, selectedMarker:', selectedMarker);
            
            if (!selectedMarker) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ‡è®°ç‚¹ï¼');
                console.log('æ²¡æœ‰é€‰ä¸­çš„æ ‡è®°');
                return;
            }
            
            const isTemp = selectedMarker.dataset.temp === 'true';
            console.log('æ˜¯å¦ä¸´æ—¶æ ‡è®°:', isTemp);
            
            if (!isTemp) {
                    // åˆ é™¤æ­£å¼æ ‡è®°
                    const index = riskPoints.findIndex(point => point.marker === selectedMarker);
                console.log('åœ¨riskPointsä¸­æ‰¾åˆ°çš„ç´¢å¼•:', index);
                
                    if (index !== -1) {
                        riskPoints.splice(index, 1);
                    console.log('ä»riskPointsæ•°ç»„ä¸­ç§»é™¤ï¼Œå‰©ä½™æ ‡è®°æ•°:', riskPoints.length);
                }
                
                // æ›´æ–°æ•°æ®ç‚¹åˆ—è¡¨
                updateRiskList();
                
                // ä¿å­˜æ•°æ®
                try {
                    await saveData();
                } catch (error) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                }
            }
            
            selectedMarker.remove();
                selectedMarker = null;
            console.log('æ ‡è®°å·²åˆ é™¤');
                
                // æ¸…é™¤è¡¨å•
                document.getElementById('risk-title').value = '';
                document.getElementById('risk-description').value = '';
                document.getElementById('risk-type').value = '';
                document.getElementById('risk-data').value = '';
                
            // éšè—æ›´æ–°æŒ‰é’®
            document.getElementById('update-marker-btn').style.display = 'none';
            
            alert('æ ‡è®°å·²åˆ é™¤ï¼');
        }
        
        // æ›´æ–°æ•°æ®ç‚¹åˆ—è¡¨
        function updateRiskList() {
            const riskItemsContainer = document.getElementById('risk-items');
            riskItemsContainer.innerHTML = '';
            
            riskPoints.forEach(point => {
                const item = document.createElement('div');
                item.className = 'risk-item';
                item.innerHTML = `
                    <div class="risk-title">${point.title}</div>
                    <div class="risk-description">${point.description.substring(0, 50)}...</div>
                `;
                
                item.addEventListener('click', function() {
                    // æ»šåŠ¨åˆ°æ ‡è®°ä½ç½®
                    point.marker.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (isAdminMode) {
                        selectMarker(point.marker);
                    }
                });
                
                riskItemsContainer.appendChild(item);
            });
        }
        
        
        // æ£€æŸ¥axiosæ˜¯å¦å¯ç”¨çš„å·¥å…·å‡½æ•°
        function ensureAxiosAvailable() {
            return new Promise((resolve, reject) => {
                if (typeof axios !== 'undefined') {
                    resolve(axios);
                    return;
                }
                
                // ç­‰å¾…axiosåŠ è½½ï¼Œæœ€å¤šç­‰å¾…10ç§’
                let attempts = 0;
                const maxAttempts = 50; // 50æ¬¡ * 200ms = 10ç§’
                
                const checkAxios = () => {
                    attempts++;
                    if (typeof axios !== 'undefined') {
                        resolve(axios);
                    } else if (attempts >= maxAttempts) {
                        // å¦‚æœaxiosä¸å¯ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªåŸºäºfetchçš„å…¼å®¹å±‚
                        console.warn('axiosåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨fetchä½œä¸ºå¤‡ç”¨');
                        const fetchAxios = {
                            request: async function(config) {
                                try {
                                    const response = await fetch(config.url, {
                                        method: config.method || 'GET',
                                        headers: config.headers || {},
                                        body: config.data ? JSON.stringify(config.data) : undefined
                                    });
                                    
                                    if (!response.ok) {
                                        const error = new Error(`HTTP ${response.status} ${response.statusText}`);
                                        error.response = {
                                            status: response.status,
                                            statusText: response.statusText
                                        };
                                        throw error;
                                    }
                                    
                                    let data;
                                    try {
                                        data = await response.json();
                                    } catch (e) {
                                        // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œè¿”å›æ–‡æœ¬
                                        data = await response.text();
                                    }
                                    
                                    return { data: data };
                                } catch (error) {
                                    if (!error.response) {
                                        // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–é”™è¯¯
                                        error.request = true;
                                    }
                                    throw error;
                                }
                            }
                        };
                        resolve(fetchAxios);
                    } else {
                        setTimeout(checkAxios, 200);
                    }
                };
                
                checkAxios();
            });
        }

        // API å·¥å…·å‡½æ•° - ä½¿ç”¨ axios æˆ– fetch å¤‡ç”¨
        async function apiRequest(endpoint, options = {}) {
            // åŠ¨æ€æ„å»ºURLå¹¶å‘é€è¯·æ±‚
            async function makeRequest(baseUrl) {
                const url = `${baseUrl}${endpoint}`;
                
                console.log(`ğŸ”„ APIè¯·æ±‚: ${options.method || 'GET'} ${url}`);
                
                try {
                    // ç¡®ä¿axioså¯ç”¨
                    const axiosInstance = await ensureAxiosAvailable();
                    
                    const axiosConfig = {
                        method: options.method || 'GET',
                        url: url,
                        timeout: API_CONFIG.timeout,
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            ...options.headers
                        },
                        // å¯¹äºè·¨åŸŸè¯·æ±‚çš„é‡è¦è®¾ç½®
                        withCredentials: false,
                        ...options
                    };
                    
                    // å¦‚æœæœ‰è¯·æ±‚ä½“æ•°æ®ï¼Œæ·»åŠ åˆ°é…ç½®ä¸­
                    if (options.data) {
                        axiosConfig.data = options.data;
                    } else if (options.body) {
                        // å‘åå…¼å®¹ï¼šå¦‚æœä½¿ç”¨çš„æ˜¯ bodyï¼Œåˆ™å°†å…¶è½¬æ¢ä¸º data
                        axiosConfig.data = JSON.parse(options.body);
                    }
                    
                    const response = await axiosInstance.request(axiosConfig);
                    console.log(`âœ… APIå“åº”:`, response.data);
                    return response.data;
                } catch (error) {
                    // ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
                    if (error.response) {
                        // æœåŠ¡å™¨å“åº”äº†é”™è¯¯çŠ¶æ€ç 
                        throw new Error(`HTTPé”™è¯¯: ${error.response.status} ${error.response.statusText}`);
                    } else if (error.request) {
                        // è¯·æ±‚å·²å‘é€ä½†æ²¡æœ‰æ”¶åˆ°å“åº”
                        throw new Error(`ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨`);
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        // fetchç›¸å…³é”™è¯¯
                        throw new Error(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                    } else {
                        // å…¶ä»–é”™è¯¯
                        throw new Error(`è¯·æ±‚é…ç½®é”™è¯¯: ${error.message}`);
                    }
                }
            }
            
            // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„URL
            const urlsToTry = [API_CONFIG.baseUrl];
            if (API_CONFIG.fallbackUrls) {
                urlsToTry.push(...API_CONFIG.fallbackUrls.filter(url => url !== API_CONFIG.baseUrl));
            }
            
            let lastError = null;
            
            // ä¾æ¬¡å°è¯•æ‰€æœ‰URL
            for (const baseUrl of urlsToTry) {
                try {
                    console.log(`ğŸ”„ å°è¯•è¯·æ±‚: ${baseUrl}${endpoint}`);
                    return await makeRequest(baseUrl);
                } catch (error) {
                    console.error(`âŒ è¯·æ±‚å¤±è´¥ (${baseUrl}):`, error.message);
                    lastError = error;
                    
                    // axios çš„è·¨åŸŸé”™è¯¯æ£€æµ‹
                    const errorMessage = error.message.toLowerCase();
                    if (errorMessage.includes('network error') || 
                        errorMessage.includes('cors') || 
                        errorMessage.includes('mixed content') || 
                        errorMessage.includes('blocked') ||
                        errorMessage.includes('failed to fetch') ||
                        error.code === 'ERR_NETWORK') {
                        console.log('ğŸ”„ æ£€æµ‹åˆ°è·¨åŸŸç›¸å…³é”™è¯¯ï¼Œå°è¯•ä¸‹ä¸€ä¸ªURL...');
                        continue;
                    } else {
                        // å¦‚æœæ˜¯å…¶ä»–ç±»å‹çš„é”™è¯¯ï¼ˆæ¯”å¦‚404ï¼‰ï¼Œå¯èƒ½ä¸éœ€è¦ç»§ç»­å°è¯•
                        console.log('ğŸ”„ æ£€æµ‹åˆ°å…¶ä»–ç±»å‹é”™è¯¯ï¼Œä½†ä»å°è¯•ä¸‹ä¸€ä¸ªURL...');
                    }
                }
            }
            
            // æ‰€æœ‰URLéƒ½å¤±è´¥äº†
            const errorMessage = `æ‰€æœ‰APIè¯·æ±‚éƒ½å¤±è´¥äº†ã€‚æœ€åé”™è¯¯: ${lastError?.message}\n\nè¿™é€šå¸¸æ˜¯å› ä¸º:\n` +
                `1. è·¨åŸŸï¼ˆCORSï¼‰é…ç½®é—®é¢˜ - æœåŠ¡å™¨éœ€è¦è®¾ç½®æ­£ç¡®çš„CORSå¤´\n` +
                `2. Mixed Contenté—®é¢˜ - HTTPSé¡µé¢æ— æ³•è¯·æ±‚HTTPèµ„æº\n` +
                `3. ç½‘ç»œè¿æ¥é—®é¢˜\n\n` +
                `è§£å†³æ–¹æ¡ˆ:\n` +
                `1. åœ¨æœåŠ¡å™¨ç«¯é…ç½®CORSå¤´: Access-Control-Allow-Origin: *\n` +
                `2. ä¸ºAPIæœåŠ¡å™¨é…ç½®HTTPSè¯ä¹¦\n` +
                `3. æˆ–è€…ä½¿ç”¨Netlify Functionsä½œä¸ºä»£ç†`;
            
            console.error('âŒ æ‰€æœ‰APIè¯·æ±‚å¤±è´¥:', errorMessage);
            throw new Error(errorMessage);
        }
        
        // ä»APIè·å–æ ‡è®°ç‚¹æ•°æ®
        async function loadDataFromAPI() {
            try {
                console.log('ğŸ”„ å¼€å§‹ä»APIåŠ è½½æ ‡è®°æ•°æ®...');
                console.log('å½“å‰APIé…ç½®:', API_CONFIG);
                const result = await apiRequest('/markers');
                
                if (result && typeof result === 'object') {
                    if (result.success && result.data) {
                        console.log(`âœ… APIè¿”å›æˆåŠŸï¼Œè·å¾— ${result.data.length} ä¸ªæ ‡è®°ç‚¹`);
                        return result.data;
                    } else {
                        console.warn('âš ï¸ APIè¿”å›æ ¼å¼å¼‚å¸¸:', result);
                        // æœ‰æ—¶å€™APIå¯èƒ½ç›´æ¥è¿”å›æ•°ç»„è€Œä¸æ˜¯åŒ…è£…å¯¹è±¡
                        if (Array.isArray(result)) {
                            console.log(`âœ… APIç›´æ¥è¿”å›æ•°ç»„ï¼Œè·å¾— ${result.length} ä¸ªæ ‡è®°ç‚¹`);
                            return result;
                        }
                        throw new Error(result.message || 'APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                } else {
                    throw new Error('APIè¿”å›äº†æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                }
            } catch (error) {
                console.error('ä»APIåŠ è½½æ•°æ®å¤±è´¥:', error);
                // æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    console.error('ğŸ” è¿™å¯èƒ½æ˜¯è·¨åŸŸæˆ–ç½‘ç»œè¿æ¥é—®é¢˜');
                }
                throw error;
            }
        }
        
        // ä¿å­˜æ•°æ®åˆ°API
        async function saveDataToAPI() {
            try {
                const dataToSave = riskPoints.map(point => {
                    // ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½æœ‰å€¼
                    const x = point.percentX !== undefined ? point.percentX : (point.x || 0);
                    const y = point.percentY !== undefined ? point.percentY : (point.y || 0);
                    
                    // å¤„ç†å›¾ç‰‡æ•°æ®ï¼šä¿å­˜å®Œæ•´çš„å¤šå›¾ç‰‡æ•°ç»„åˆ°æ•°æ®åº“
                    let imageDataForDB = null;
                    if (point.imageData) {
                        console.log(`ä¿å­˜æ ‡è®°ç‚¹ ${point.title} çš„å›¾ç‰‡æ•°æ®:`, point.imageData);
                        if (Array.isArray(point.imageData)) {
                            // å¦‚æœæ˜¯æ•°ç»„ï¼Œä¿å­˜æ•´ä¸ªæ•°ç»„
                            imageDataForDB = point.imageData;
                            console.log(`ä¿å­˜å¤šå›¾ç‰‡æ•°ç»„ï¼ŒåŒ…å« ${point.imageData.length} å¼ å›¾ç‰‡`);
                        } else if (typeof point.imageData === 'string') {
                            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºæ•°ç»„ä¿å­˜
                            imageDataForDB = [point.imageData];
                            console.log('å°†å•å¼ å›¾ç‰‡è½¬æ¢ä¸ºæ•°ç»„ä¿å­˜');
                        }
                    }
                    
                    return {
                        id: point.id,
                        x: x,
                        y: y,
                        percentX: x,  // æ˜ç¡®è®¾ç½®ç™¾åˆ†æ¯”åæ ‡
                        percentY: y,
                        percent_x: x, // æ•°æ®åº“å­—æ®µæ ¼å¼
                        percent_y: y,
                        type: point.type,
                        title: point.title || 'æœªå‘½åæ ‡è®°',
                        description: point.description || null,
                        data: point.data || null,
                        imageData: imageDataForDB  // ä¿å­˜å®Œæ•´çš„å¤šå›¾ç‰‡æ•°ç»„åˆ°æ•°æ®åº“
                    };
                });
                
                console.log('å‡†å¤‡ä¿å­˜çš„æ•°æ®:', dataToSave);
                
                const result = await apiRequest('/markers/batch', {
                    method: 'POST',
                    data: dataToSave  // axios ä½¿ç”¨ data è€Œä¸æ˜¯ bodyï¼Œä¸”ä¼šè‡ªåŠ¨ JSON.stringify
                });
                
                if (result.success) {
                    console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨:', result);
                    return true;
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®åˆ°APIå¤±è´¥:', error);
                throw error;
            }
        }
        
        // è·å–åµŒå…¥å¼é»˜è®¤æ•°æ®ï¼ˆç”¨äºç¦»çº¿ä½¿ç”¨ï¼‰
        function getEmbeddedData() {
            // è¿™ä¸ªæ•°æ®å°†åœ¨HTMLæ–‡ä»¶ç”Ÿæˆæ—¶è‡ªåŠ¨å¡«å……
            return window.embeddedMapData || [];
        }
        
        // ä¿®å¤è¢«å¤šæ¬¡åºåˆ—åŒ–çš„å›¾ç‰‡æ•°æ®
        function fixSerializedImageData(imageData) {
            if (!imageData) return null;
            
            // å¦‚æœå·²ç»æ˜¯æ•°ç»„ï¼Œç›´æ¥è¿”å›
            if (Array.isArray(imageData)) {
                return imageData;
            }
            
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è§£åºåˆ—åŒ–
            if (typeof imageData === 'string') {
                // æ£€æŸ¥æ˜¯å¦çœ‹èµ·æ¥åƒè¢«å¤šæ¬¡JSON.stringifyè¿‡çš„å­—ç¬¦ä¸²
                if (imageData.startsWith('[') || (imageData.startsWith('"') && imageData.includes('[\\\"'))) {
                    try {
                        // å°è¯•è§£æï¼Œå¯èƒ½è¢«å¤šæ¬¡JSON.stringifyè¿‡
                        let parsed = imageData;
                        let iterations = 0;
                        const maxIterations = 5; // é˜²æ­¢æ— é™å¾ªç¯
                        
                        while (typeof parsed === 'string' && iterations < maxIterations) {
                            // æ£€æŸ¥æ˜¯å¦çœ‹èµ·æ¥åƒJSONå­—ç¬¦ä¸²
                            if ((parsed.startsWith('[') && parsed.endsWith(']')) || 
                                (parsed.startsWith('"') && parsed.endsWith('"'))) {
                                try {
                                    const temp = JSON.parse(parsed);
                                    if (Array.isArray(temp)) {
                                        parsed = temp;
                                        break; // æ‰¾åˆ°æ•°ç»„å°±åœæ­¢
                                    } else if (typeof temp === 'string') {
                                        parsed = temp;
                                        iterations++;
                                    } else {
                                        break;
                                    }
                                } catch (e) {
                                    break;
                                }
                            } else {
                                break;
                            }
                        }
                        
                        console.log(`ä¿®å¤åºåˆ—åŒ–æ•°æ®ï¼Œè¿­ä»£æ¬¡æ•°: ${iterations}`, typeof parsed, parsed);
                        return parsed;
                    } catch (e) {
                        console.warn('æ— æ³•è§£æå›¾ç‰‡æ•°æ®:', imageData.substring(0, 100) + '...', e);
                        return null;
                    }
                }
                
                // å¦‚æœæ˜¯æ­£å¸¸çš„å­—ç¬¦ä¸²ï¼ˆå¦‚base64ï¼‰ï¼Œç›´æ¥è¿”å›
                return imageData;
            }
            
            return imageData;
        }
        
        // åŠ è½½æ•°æ®çš„é€šç”¨å‡½æ•°
        function processMarkerData(data) {
            data.forEach(point => {
                let x, y;
                if (point.percentX !== undefined && point.percentY !== undefined) {
                    // æ–°æ ¼å¼ï¼šä½¿ç”¨ç™¾åˆ†æ¯”åæ ‡
                    x = point.percentX;
                    y = point.percentY;
                } else if (point.percent_x !== undefined && point.percent_y !== undefined) {
                    // æ•°æ®åº“æ ¼å¼ï¼šä½¿ç”¨percent_xå’Œpercent_yå­—æ®µ
                    x = point.percent_x;
                    y = point.percent_y;
                } else {
                    // æ—§æ ¼å¼æˆ–å…¶ä»–æ ¼å¼ï¼šç›´æ¥ä½¿ç”¨åŸåæ ‡
                    x = point.x;
                    y = point.y;
                }
                
                // è°ƒè¯•å’Œä¿®å¤ï¼šæŸ¥çœ‹åŠ è½½çš„å›¾ç‰‡æ•°æ®
                let imageData = point.imageData || point.image_data;
                if (imageData) {
                    console.log(`åŠ è½½æ ‡è®°ç‚¹ ${point.title} çš„åŸå§‹å›¾ç‰‡æ•°æ®:`, imageData, `ç±»å‹: ${typeof imageData}`, `æ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(imageData)}`);
                    
                    // ä¿®å¤å¯èƒ½çš„åºåˆ—åŒ–é—®é¢˜
                    imageData = fixSerializedImageData(imageData);
                    console.log(`ä¿®å¤åçš„å›¾ç‰‡æ•°æ®:`, imageData);
                }
                addRiskPoint(x, y, point.type, point.title, point.description, point.id, point.data, imageData);
            });
            updateRiskList();
            
            // æ›´æ–°æ ‡è®°ä½ç½®ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            setTimeout(() => {
                updateAllMarkerPositions();
            }, 500);
        }

        // ä»APIã€æœ¬åœ°å­˜å‚¨å’Œdata.jsonæ–‡ä»¶åŠ è½½æ•°æ®
        async function loadData() {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½æ•°æ®...');
            
            // 1. é¦–å…ˆå°è¯•ä»APIåŠ è½½æ•°æ®ï¼ˆåœ¨çº¿æ¨¡å¼ï¼Œå¤šç”¨æˆ·å…±äº«ï¼‰
            try {
                console.log('ğŸŒ å°è¯•ä»APIåŠ è½½æ•°æ®...');
                const apiData = await loadDataFromAPI();
                if (apiData && apiData.length > 0) {
                    console.log(`âœ… æˆåŠŸä»APIåŠ è½½æ•°æ®ï¼ŒåŒ…å« ${apiData.length} ä¸ªæ ‡è®°ç‚¹`);
                    processMarkerData(apiData);
                    return;
                }
            } catch (apiError) {
                console.log('âš ï¸ APIåŠ è½½å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼:', apiError.message);
            }
            
            // 2. å°è¯•ä»data.jsonæ–‡ä»¶åŠ è½½ï¼ˆæœ¬åœ°æ–‡ä»¶æ¨¡å¼ï¼‰
            try {
                console.log('ğŸ“ å°è¯•ä»data.jsonåŠ è½½...');
                const response = await fetch('data.json', {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`âœ… æˆåŠŸä»data.jsonåŠ è½½æ•°æ®ï¼ŒåŒ…å« ${data.length} ä¸ªæ ‡è®°ç‚¹`);
                    processMarkerData(data);
                    return;
                }
            } catch (e) {
                console.log('âš ï¸ æ— æ³•åŠ è½½data.jsonæ–‡ä»¶:', e.message);
            }
            
            // 3. å°è¯•åŠ è½½åµŒå…¥å¼æ•°æ®ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
            try {
                console.log('ğŸ“¦ å°è¯•åŠ è½½åµŒå…¥å¼æ•°æ®...');
                const embeddedData = getEmbeddedData();
                if (embeddedData && embeddedData.length > 0) {
                    console.log(`âœ… æ‰¾åˆ°åµŒå…¥å¼æ•°æ®ï¼ŒåŒ…å« ${embeddedData.length} ä¸ªæ ‡è®°ç‚¹`);
                    processMarkerData(embeddedData);
                    return;
                }
            } catch (embeddedError) {
                console.log('âš ï¸ åµŒå…¥å¼æ•°æ®åŠ è½½å¤±è´¥:', embeddedError.message);
            }
            
            // 4. æœ€åå°è¯•ä»localStorageåŠ è½½ï¼ˆæœ¬åœ°ç¼“å­˜æ¨¡å¼ï¼‰
            const savedData = localStorage.getItem('campusRiskPoints');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    console.log(`âœ… æˆåŠŸä»localStorageåŠ è½½æ•°æ®ï¼ŒåŒ…å« ${data.length} ä¸ªæ ‡è®°ç‚¹`);
                    processMarkerData(data);
                    console.log('ğŸ’¾ æ•°æ®åŠ è½½å®Œæˆ');
                    return;
                } catch (e) {
                    console.error('âŒ localStorageåŠ è½½å¤±è´¥:', e);
                }
            }
            
            // 5. å¦‚æœæ‰€æœ‰æ–¹å¼éƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
            console.log('âš ï¸ æœªèƒ½åŠ è½½ä»»ä½•æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¼€å§‹ï¼');
            setTimeout(() => {
                if (riskPoints.length === 0) {
                    console.log('ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥å¼€å§‹æ·»åŠ æ ‡è®°äº†ï¼ç‚¹å‡»"æ·»åŠ æ ‡è®°"æŒ‰é’®å¼€å§‹ã€‚');
                }
            }, 1000);
        }
        
        // ä¿å­˜æ•°æ®ï¼ˆAPIå’Œæœ¬åœ°å­˜å‚¨åŒé‡ä¿å­˜ï¼‰
        async function saveData() {
            const dataToSave = riskPoints.map(point => ({
                id: point.id,
                x: point.percentX !== undefined ? point.percentX : point.x, // ä¼˜å…ˆä½¿ç”¨ç™¾åˆ†æ¯”åæ ‡
                y: point.percentY !== undefined ? point.percentY : point.y,
                percentX: point.percentX !== undefined ? point.percentX : point.x, // æ˜ç¡®ä¿å­˜ç™¾åˆ†æ¯”åæ ‡
                percentY: point.percentY !== undefined ? point.percentY : point.y,
                type: point.type,
                title: point.title,
                data: point.data || '',
                description: point.description,
                imageData: point.imageData || null
            }));
            
            // 1. ä¼˜å…ˆä¿å­˜åˆ°APIï¼ˆå¤šç”¨æˆ·å…±äº«ï¼‰
            try {
                console.log('ğŸ”„ æ­£åœ¨ä¿å­˜æ•°æ®åˆ°æœåŠ¡å™¨...');
                await saveDataToAPI();
                console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
            } catch (apiError) {
                console.warn('âš ï¸ ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°:', apiError.message);
            }
            
            // 2. åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆç¦»çº¿å¤‡ä»½ï¼‰
            try {
            localStorage.setItem('campusRiskPoints', JSON.stringify(dataToSave));
                console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (localError) {
                console.error('âŒ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', localError.message);
        }
        }
        
    </script>
</body>
</html>